___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Rokt Event API",
  "brand": {
    "id": "brand_dummy",
    "displayName": "gtm-templates-praba",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Unofficial tag template for Server-side GTM to send conversion data to Rokt Ads via their Event API. Documentation: https://docs.rokt.com/developers/api-reference/event-api",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "apiConfiguration",
    "displayName": "API Configuration",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "accountId",
        "displayName": "Rokt Account ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Your Rokt Account ID (up to 64 characters)"
      },
      {
        "type": "TEXT",
        "name": "rpub",
        "displayName": "Rokt Public Key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^rpub-.*"
            ]
          }
        ],
        "help": "Your Rokt Public Key (format: rpub-xxxx-xxxx)"
      },
      {
        "type": "TEXT",
        "name": "rsec",
        "displayName": "Rokt Secret Key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^rsec-.*"
            ]
          }
        ],
        "help": "Your Rokt Secret Key (format: rsec-xxxx-xxxx)"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "eventData",
    "displayName": "Event Data",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventType",
        "displayName": "Event Type",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "The type of event (e.g., sign_up, purchase, booking, conversion)",
        "defaultValue": "sign_up"
      },
      {
        "type": "TEXT",
        "name": "passbackconversiontrackingid",
        "displayName": "Rokt Tracking ID",
        "simpleValueType": true,
        "help": "Rokt-generated ID used to match conversion events to the originating click"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalData",
    "displayName": "Additional Object Data",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "objectDataTable",
        "displayName": "Object Data",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "help": "Additional parameters to include with the event, such as email, amount, currency, etc. Refer to \u003ca href\u003d\"https://docs.rokt.com/developers/api-reference/event-api/#objectdata-fields\" target\u003d\"_blank\"\u003ethis link\u003c/a\u003e for the full list of supported fields."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "metadata",
    "displayName": "Metadata",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "metaDataTable",
        "displayName": "Meta Data",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Name",
            "name": "name",
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "help": "Additional non-business critical information to send with the event"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

// APIs
const createRegex = require('createRegex');
const generateRandom = require('generateRandom');
const getContainerVersion = require('getContainerVersion');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeString = require('makeString');
const Math = require('Math');
const sendHttpRequest = require('sendHttpRequest');
const testRegex = require('testRegex');
const toBase64 = require('toBase64');

// Detect if debug mode is enabled
const containerVer = getContainerVersion();
const isDebug = containerVer.debugMode;

// Constants
const API_ENDPOINT = 'https://api.rokt.com/v2/events';
const ROKT_VERSION = '2020-05-21';

// Date calculation constants
const leapYear = [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
const nonLeapYear = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

/**
 * Generate a random client event ID (max 36 characters)
 */
function generateClientEventId() {
  const timestamp = getTimestampMillis();
  const randomNum = generateRandom(100000, 999999);
  const clientEventId = 'sgtm-' + timestamp + '-' + randomNum;

  // Ensure it's within 36 character limit
  return clientEventId.length > 36 ? clientEventId.substring(0, 36) : clientEventId;
}

/**
 * Helper functions for time conversion
 */
const secToMs = (s) => s * 1000;
const minToMs = (m) => m * secToMs(60);
const hoursToMs = (h) => h * minToMs(60);
const daysToMs = (d) => d * hoursToMs(24);

const padStart = (value, length) => {
  let result = makeString(value);
  while (result.length < length) {
    result = '0' + result;
  }
  return result;
};

/**
 * Convert timestamp to ISO 8601 format
 */
function convertTimestampToISO(timestamp) {
  const fourYearsInMs = daysToMs(365 * 4 + 1);
  let year = 1970 + Math.floor(timestamp / fourYearsInMs) * 4;
  timestamp = timestamp % fourYearsInMs;

  while (true) {
    let isLeapYear = year % 4 === 0;
    let nextTimestamp = timestamp - daysToMs(isLeapYear ? 366 : 365);
    if (nextTimestamp < 0) {
      break;
    }
    timestamp = nextTimestamp;
    year = year + 1;
  }

  const daysByMonth = year % 4 === 0 ? leapYear : nonLeapYear;

  let month = 0;
  for (let i = 0; i < daysByMonth.length; i++) {
    let msInThisMonth = daysToMs(daysByMonth[i]);
    if (timestamp > msInThisMonth) {
      timestamp = timestamp - msInThisMonth;
    } else {
      month = i + 1;
      break;
    }
  }

  let date = Math.ceil(timestamp / daysToMs(1));
  timestamp = timestamp - daysToMs(date - 1);
  let hours = Math.floor(timestamp / hoursToMs(1));
  timestamp = timestamp - hoursToMs(hours);
  let minutes = Math.floor(timestamp / minToMs(1));
  timestamp = timestamp - minToMs(minutes);
  let sec = Math.floor(timestamp / secToMs(1));
  timestamp = timestamp - secToMs(sec);
  let milliSeconds = timestamp;

  return (
    year +
    '-' +
    padStart(month, 2) +
    '-' +
    padStart(date, 2) +
    'T' +
    padStart(hours, 2) +
    ':' +
    padStart(minutes, 2) +
    ':' +
    padStart(sec, 2) +
    '.' +
    padStart(milliSeconds, 3) +
    'Z'
  );
}

/**
 * Generate ISO 8601 timestamp for eventTime using current timestamp
 */
function generateEventTime() {
  return convertTimestampToISO(getTimestampMillis());
}

/**
 * Create Basic Auth header from public and private keys
 */
function createAuthHeader(publicKey, secretKey) {
  const credentials = publicKey + ':' + secretKey;
  return 'Basic ' + toBase64(credentials);
}

/**
 * Check if string starts with a prefix (case insensitive)
 */
function startsWithIgnoreCase(str, prefix) {
  if (!str || !prefix) return false;
  const lowerStr = makeString(str).toLowerCase();
  const lowerPrefix = makeString(prefix).toLowerCase();
  return lowerStr.substring(0, lowerPrefix.length) === lowerPrefix;
}

/**
 * Build object data array from template parameters
 */
function buildObjectData() {
  const objectData = [];

  // Add passbackconversiontrackingid if provided
  if (data.passbackconversiontrackingid) {
    objectData.push({
      name: 'passbackconversiontrackingid',
      value: makeString(data.passbackconversiontrackingid)
    });
  }

  // Add additional object data from table
  if (data.objectDataTable && getType(data.objectDataTable) === 'array') {
    data.objectDataTable.forEach(function (row) {
      if (row.name && row.value) {
        // Validate field name doesn't start with 'rokt.' (case insensitive)
        if (!startsWithIgnoreCase(row.name, 'rokt.')) {
          objectData.push({
            name: makeString(row.name),
            value: makeString(row.value)
          });
        } else if (isDebug) {
          logToConsole(
            JSON.stringify({
              Name: 'RoktEventAPI',
              Type: 'Warning',
              Message: 'Skipping field "' + row.name + '" - rokt. prefix is reserved'
            })
          );
        }
      }
    });
  }

  return objectData;
}

/**
 * Build metadata array from template parameters
 */
function buildMetaData() {
  const metaData = [];

  // Add metadata from table
  if (data.metaDataTable && getType(data.metaDataTable) === 'array') {
    data.metaDataTable.forEach(function (row) {
      if (row.name && row.value) {
        // Validate field name doesn't start with 'rokt.' (case insensitive)
        if (!startsWithIgnoreCase(row.name, 'rokt.')) {
          metaData.push({
            name: makeString(row.name),
            value: makeString(row.value)
          });
        } else if (isDebug) {
          logToConsole(
            JSON.stringify({
              Name: 'RoktEventAPI',
              Type: 'Warning',
              Message: 'Skipping metadata field "' + row.name + '" - rokt. prefix is reserved'
            })
          );
        }
      }
    });
  }

  return metaData;
}

/**
 * Validate required parameters
 */
function validateParameters() {
  if (!data.accountId) {
    if (isDebug) {
      logToConsole(
        JSON.stringify({
          Name: 'RoktEventAPI',
          Type: 'Error',
          Message: 'Missing accountId'
        })
      );
    }
    return false;
  }

  const rpubRegex = createRegex('^rpub-');
  if (!data.rpub || !testRegex(rpubRegex, data.rpub)) {
    if (isDebug) {
      logToConsole(
        JSON.stringify({
          Name: 'RoktEventAPI',
          Type: 'Error',
          Message: 'Invalid Rokt Public Key format'
        })
      );
    }
    return false;
  }

  const rsecRegex = createRegex('^rsec-');
  if (!data.rsec || !testRegex(rsecRegex, data.rsec)) {
    if (isDebug) {
      logToConsole(
        JSON.stringify({
          Name: 'RoktEventAPI',
          Type: 'Error',
          Message: 'Invalid Rokt Secret Key format'
        })
      );
    }
    return false;
  }

  if (!data.eventType) {
    if (isDebug) {
      logToConsole(
        JSON.stringify({
          Name: 'RoktEventAPI',
          Type: 'Error',
          Message: 'Missing eventType'
        })
      );
    }
    return false;
  }

  return true;
}

/**
 * Parse JSON response safely
 */
function parseJsonSafe(jsonString) {
  const parsed = JSON.parse(jsonString);
  return parsed;
}

/**
 * Main execution function
 */
function main() {
  // Validate parameters
  if (!validateParameters()) {
    data.gtmOnFailure();
    return;
  }

  // Build event object
  const event = {
    clientEventId: generateClientEventId(),
    eventType: makeString(data.eventType),
    eventTime: generateEventTime(),
    objectData: buildObjectData()
  };

  // Add metadata if present
  const metaData = buildMetaData();
  if (metaData.length > 0) {
    event.metaData = metaData;
  }

  // Build request payload
  const requestBody = {
    accountId: makeString(data.accountId),
    events: [event]
  };

  // Build headers
  const headers = {
    'Content-Type': 'application/json',
    Charset: 'utf-8',
    'Rokt-Version': ROKT_VERSION,
    Authorization: createAuthHeader(data.rpub, data.rsec)
  };

  // Log request
  if (isDebug) {
    logToConsole(
      JSON.stringify({
        Name: 'RoktEventAPI',
        Type: 'Request',
        RequestMethod: 'POST',
        RequestUrl: API_ENDPOINT,
        RequestBody: requestBody,
        RequestHeaders: headers,
        EventDetails: {
          EventType: event.eventType,
          ClientEventId: event.clientEventId,
          EventTime: event.eventTime,
          ObjectDataCount: event.objectData.length,
          MetaDataCount: event.metaData ? event.metaData.length : 0
        }
      })
    );
  }

  // Send HTTP request
  sendHttpRequest(
    API_ENDPOINT,
    {
      headers: headers,
      method: 'POST',
      timeout: 5000
    },
    JSON.stringify(requestBody)
  ).then(
    function (result) {
      // Log response if in debug mode
      if (isDebug) {
        logToConsole(
          JSON.stringify({
            Name: 'RoktEventAPI',
            Type: 'Response',
            ResponseStatusCode: result.statusCode,
            ResponseHeaders: result.headers,
            ResponseBody: result.body
          })
        );
      }

      if (result.statusCode >= 200 && result.statusCode < 300) {
        // Parse response to check for unprocessed records
        const response = parseJsonSafe(result.body);
        if (response && response.data && response.data.unprocessedRecords) {
          if (response.data.unprocessedRecords.length > 0) {
            if (isDebug) {
              logToConsole(
                JSON.stringify({
                  Name: 'RoktEventAPI',
                  Type: 'Warning',
                  Message: 'Some records were not processed',
                  UnprocessedRecords: response.data.unprocessedRecords
                })
              );
            }
            // Still call success as HTTP status was 200, but log the issues
            data.gtmOnSuccess();
          } else {
            if (isDebug) {
              logToConsole(
                JSON.stringify({
                  Name: 'RoktEventAPI',
                  Type: 'Success',
                  Message: 'All events processed successfully'
                })
              );
            }
            data.gtmOnSuccess();
          }
        } else {
          data.gtmOnSuccess();
        }
      } else {
        if (isDebug) {
          logToConsole(
            JSON.stringify({
              Name: 'RoktEventAPI',
              Type: 'Error',
              Message: 'HTTP Error',
              StatusCode: result.statusCode,
              ErrorBody: result.body
            })
          );
        }
        data.gtmOnFailure();
      }
    },
    function (error) {
      if (isDebug) {
        logToConsole(
          JSON.stringify({
            Name: 'RoktEventAPI',
            Type: 'Error',
            Message: 'Request failed',
            Error: error
          })
        );
      }
      data.gtmOnFailure();
    }
  );
}

// Execute main function
main();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.rokt.com/v2/events"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Missing Account ID - Should Fail
  code: |-
    const mockData = {
      // accountId missing
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh',
      eventType: 'sign_up'
    };

    runCode(mockData);

    // Should fail due to missing accountId
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Empty Account ID - Should Fail
  code: |-
    const mockData = {
      accountId: '',
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh',
      eventType: 'sign_up'
    };

    runCode(mockData);

    // Should fail due to empty accountId
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Invalid Rokt Public Key Format - Should Fail
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'invalid-key-format',
      rsec: 'rsec-abcd-efgh',
      eventType: 'sign_up'
    };

    runCode(mockData);

    // Should fail due to invalid rpub format
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Missing Rokt Public Key - Should Fail
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      // rpub missing
      rsec: 'rsec-abcd-efgh',
      eventType: 'sign_up'
    };

    runCode(mockData);

    // Should fail due to missing rpub
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Invalid Rokt Secret Key Format - Should Fail
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      rsec: 'invalid-secret-format',
      eventType: 'sign_up'
    };

    runCode(mockData);

    // Should fail due to invalid rsec format
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Missing Rokt Secret Key - Should Fail
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      // rsec missing
      eventType: 'sign_up'
    };

    runCode(mockData);

    // Should fail due to missing rsec
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Missing Event Type - Should Fail
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh'
      // eventType missing
    };

    runCode(mockData);

    // Should fail due to missing eventType
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Empty Event Type - Should Fail
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh',
      eventType: ''
    };

    runCode(mockData);

    // Should fail due to empty eventType
    assertApi('gtmOnFailure').wasCalled();
    assertApi('gtmOnSuccess').wasNotCalled();
- name: Valid Parameters with Optional Fields
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh',
      eventType: 'purchase',
      passbackconversiontrackingid: 'tracking-123-456',
      objectDataTable: [
        { name: 'email', value: 'test@example.com' },
        { name: 'amount', value: '99.99' }
      ],
      metaDataTable: [
        { name: 'source', value: 'website' },
        { name: 'campaign', value: 'summer2024' }
      ]
    };

    // Mock the sendHttpRequest with a function that returns a mock promise-like object
    mock('sendHttpRequest', (url, options, body) => {
      return {
        then: (successCallback, errorCallback) => {
          // Call the success callback with our mock response
          successCallback({
            statusCode: 200,
            body: '{"data":{"unprocessedRecords":[]}}'
          });
        }
      };
    });

    mock('getTimestampMillis', 1642684800000);

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Valid Parameters - All Required Fields Present
  code: |-
    // Test with all valid required parameters
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh',
      eventType: 'sign_up'
    };

    // Mock the sendHttpRequest with a function that returns a mock promise-like object
    mock('sendHttpRequest', (url, options, body) => {
      return {
        then: (successCallback, errorCallback) => {
          // Call the success callback with our mock response
          successCallback({
            statusCode: 200,
            body: '{"data":{"unprocessedRecords":[]}}'
          });
        }
      };
    });

    // Mock timestamp for consistent testing
    mock('getTimestampMillis', 1642684800000);

    runCode(mockData);

    // Verify successful execution
    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();
- name: Rokt Reserved Prefix Filter Test
  code: |-
    const mockData = {
      accountId: 'test-account-123',
      rpub: 'rpub-1234-5678',
      rsec: 'rsec-abcd-efgh',
      eventType: 'conversion',
      objectDataTable: [
        { name: 'validField', value: 'validValue' },
        { name: 'rokt.reserved', value: 'shouldBeFiltered' },
        { name: 'ROKT.UPPERCASE', value: 'shouldAlsoBeFiltered' }
      ],
      metaDataTable: [
        { name: 'validMeta', value: 'validMetaValue' },
        { name: 'rokt.metaReserved', value: 'shouldBeFilteredToo' }
      ]
    };

    // Mock the sendHttpRequest with verification
    mock('sendHttpRequest', (url, options, body) => {
      // Verify that valid fields are included and rokt.* fields are filtered out
      assertThat(body).contains('validField');
      assertThat(body).contains('validValue');
      assertThat(body).contains('validMeta');
      assertThat(body).contains('validMetaValue');

      // Verify rokt.* prefixed fields are NOT included
      assertThat(body).doesNotContain('rokt.reserved');
      assertThat(body).doesNotContain('ROKT.UPPERCASE');
      assertThat(body).doesNotContain('rokt.metaReserved');

      return {
        then: (successCallback, errorCallback) => {
          successCallback({
            statusCode: 200,
            body: '{"data":{"unprocessedRecords":[]}}'
          });
        }
      };
    });

    mock('getTimestampMillis', 1642684800000);

    runCode(mockData);

    assertApi('gtmOnSuccess').wasCalled();
    assertApi('gtmOnFailure').wasNotCalled();


___NOTES___

Author: Praba Ponnambalam (praba@measureschool.com)

Releases
********

v1.0 - 2025 July 22


